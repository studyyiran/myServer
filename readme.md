修复了很多中间件相关的 bug

稍后可以实现 next

添加了 hook